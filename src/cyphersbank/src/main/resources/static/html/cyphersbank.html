<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cyphers Bank</title>
  <link rel="stylesheet" href="../style/cyphersbank.css">
</head>
<body>
  <div class="app">
    <div class="brand">
      <div class="logo">C</div>
      <div>
        <div class="bank-name">Cyphers Bank</div>
      </div>
    </div>

    <div class="layout">
      <aside class="panel sidebar">
        <div class="profile">
          <div class="avatar">P</div>
          <div>
            <div id="userName">Phuti Gift</div>
            <div class="muted" id="userAcc">Acct • 1234 5678</div>
          </div>
        </div>

        <div class="menu">
          <button class="active" data-view="dashboard">Dashboard</button>
          <button data-view="send">Send Money</button>
          <button data-view="history">Transactions</button>
          <button data-view="settings">Settings</button>
        </div>
      </aside>

      <main class="panel">
        <div id="viewContainer">
          <!-- Dashboard -->
          <section data-view-name="dashboard">
            <div class="header-row">
              <div>
                <div class="muted">Available balance</div>
                <div class="card-balance">
                  <div class="balance-amount" id="balance">R 12,500.00</div>
                  <div class="muted">Updated just now</div>
                </div>
              </div>
              <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                <button class="btn primary" id="quickSend">Send Money</button>
                <button class="btn ghost" id="topUp">Top Up</button>
              </div>
            </div>

            <div style="margin-top:18px">
              <h3>Recent transactions</h3>
              <div id="txList" class="tx-list"></div>
            </div>
          </section>

          <!-- Send Money -->
          <section class="hidden" data-view-name="send">
            <h3>Send Money</h3>
            <form id="sendForm">
              <div>
                <label class="muted">Recipient Name</label>
                <input id="recipient" required placeholder="e.g. Nomusa M" />
              </div>
              <div>
                <label class="muted">Account Number</label>
                <input id="accNumber" required placeholder="1234 5678 9012" />
              </div>
              <div class="row">
                <div style="flex:1">
                  <label class="muted">Amount (ZAR)</label>
                  <input id="amount" type="number" min="1" step="0.01" required placeholder="500" />
                </div>
                <div style="width:180px">
                  <label class="muted">Type</label>
                  <select id="type"><option>Instant</option><option>Standard</option></select>
                </div>
              </div>

              <div style="display:flex;gap:8px">
                <button class="btn primary" type="submit">Continue</button>
                <button class="btn" type="button" id="resetForm">Reset</button>
              </div>
            </form>
          </section>

          <!-- History -->
          <section class="hidden" data-view-name="history">
            <h3>Transaction History</h3>
            <div id="historyList" class="tx-list"></div>
          </section>

          <!-- Settings -->
          <section class="hidden" data-view-name="settings">
            <h3>Settings & Security</h3>
            <div style="display:grid;gap:12px;max-width:420px">
              <div>
                <label class="muted">Change 4-digit PIN</label>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <input id="newPin" placeholder="New PIN" maxlength="4" />
                  <input id="confirmPinInput" placeholder="Confirm PIN" maxlength="4" />
                  <button class="btn primary" id="changePinBtn">Save</button>
                </div>
                <div class="muted" style="margin-top:6px">Your PIN is required for sending money.</div>
              </div>

              <div>
                <label class="muted">Reset demo data</label>
                <div style="margin-top:8px">
                  <button class="btn ghost" id="resetDemo">Reset Demo (localStorage)</button>
                </div>
              </div>
            </div>
          </section>
        </div>

        <footer>
          Cyphers Bank
        </footer>
      </main>
    </div>
  </div>

  <!-- PIN Modal -->
  <div class="modal-backdrop" id="pinModal">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="pinTitle">
      <h3 id="pinTitle">Confirm transaction</h3>
      <div class="muted">Enter your 4-digit PIN to complete this payment</div>
      <div style="height:12px"></div>
      <div class="pin-input">
        <input maxlength="1" pattern="[0-9]" inputmode="numeric" class="pinCell" />
        <input maxlength="1" pattern="[0-9]" inputmode="numeric" class="pinCell" />
        <input maxlength="1" pattern="[0-9]" inputmode="numeric" class="pinCell" />
        <input maxlength="1" pattern="[0-9]" inputmode="numeric" class="pinCell" />
      </div>
      <div style="height:12px"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="btn" id="cancelPin">Cancel</button>
        <button class="btn primary" id="confirmPin">Confirm</button>
      </div>
      <div id="pinError" class="muted" style="margin-top:8px;color:#ff7b7b;display:none"></div>
    </div>
  </div>

  <script>
// ===== Demo "backend" (localStorage) =====
const STORAGE_KEY = 'cyphers_demo_v1';
const defaultState = {
  user: {name:'Phuti Gift', account:'1234 5678', balance:2500.00, pin:'1234'},
  transactions: []
};

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return JSON.parse(JSON.stringify(defaultState));
    const parsed = JSON.parse(raw) || JSON.parse(JSON.stringify(defaultState));
    parsed.user = parsed.user || JSON.parse(JSON.stringify(defaultState.user));
    parsed.transactions = Array.isArray(parsed.transactions) ? parsed.transactions : [];
    return parsed;
  }catch(e){
    return JSON.parse(JSON.stringify(defaultState));
  }
}
function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)); }
let state = loadState();

// ===== Helpers =====
function showView(name){
  document.querySelectorAll('[data-view-name]').forEach(v =>
    v.classList.toggle('hidden', v.getAttribute('data-view-name')!==name)
  );
  document.querySelectorAll('.menu button').forEach(b =>
    b.classList.toggle('active', b.dataset.view===name)
  );
}
function formatMoney(n){
  return 'R ' + Number(n).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
}
function escapeHtml(str){ return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function render(){
  document.getElementById('userName').textContent = state.user.name;
  document.getElementById('userAcc').textContent = 'Acct • ' + state.user.account;
  document.getElementById('balance').textContent = formatMoney(state.user.balance);
  renderTxList();
  renderHistory();
}
function renderTxList(){
  const el = document.getElementById('txList'); el.innerHTML='';
  const recent = state.transactions.slice().reverse().slice(0,5);
  if(recent.length===0){ el.innerHTML='<div class="muted">No recent transactions</div>'; return; }
  recent.forEach(tx=>{
    const d=document.createElement('div');d.className='tx';
    d.innerHTML=`<div><strong>${escapeHtml(tx.to)}</strong><div class="muted">${escapeHtml(tx.type)} • ${new Date(tx.date).toLocaleString()}</div></div><div><strong>${tx.amount<0?'-':''}${formatMoney(Math.abs(tx.amount))}</strong></div>`;
    el.appendChild(d);
  });
}
function renderHistory(){
  const el=document.getElementById('historyList'); el.innerHTML='';
  if(state.transactions.length===0){ el.innerHTML='<div class="muted">No transactions</div>'; return; }
  state.transactions.slice().reverse().forEach(tx=>{
    const d=document.createElement('div');d.className='tx';
    d.innerHTML=`<div><strong>${escapeHtml(tx.to)}</strong><div class="muted">${escapeHtml(tx.type)} • ${new Date(tx.date).toLocaleString()}</div></div><div><strong>${tx.amount<0?'-':''}${formatMoney(Math.abs(tx.amount))}</strong></div>`;
    el.appendChild(d);
  });
}

// ===== Send & PIN Modal =====
let pendingTx=null;
const pinModal=document.getElementById('pinModal');
const pinCells=Array.from(document.querySelectorAll('.pinCell'));
const pinError=document.getElementById('pinError');
const confirmBtn=document.getElementById('confirmPin');
const cancelBtn=document.getElementById('cancelPin');
if(confirmBtn) confirmBtn.disabled=true;

function openPinModal(tx){
  pendingTx=tx;
  pinCells.forEach(i=>{i.value=''; i.disabled=false;});
  pinError.style.display='none';
  confirmBtn.disabled=true;
  pinModal.style.display='flex';
  setTimeout(()=>pinCells[0].focus(),80);
}
function closePinModal(){ pinModal.style.display='none'; pinCells.forEach(i=>{i.value='';i.disabled=true;}); confirmBtn.disabled=true; pendingTx=null; }
function getPinFromModal(){ return pinCells.map(i=>i.value||'').join(''); }
function updateConfirmState(){ confirmBtn.disabled=getPinFromModal().length<4; if(getPinFromModal().length===4) pinError.style.display='none'; }

pinCells.forEach((cell,i)=>{
  cell.addEventListener('input',()=>{ cell.value=cell.value.replace(/[^0-9]/g,'').slice(0,1); if(cell.value&&i<3) pinCells[i+1].focus(); updateConfirmState(); });
  cell.addEventListener('keydown',ev=>{ if(ev.key==='Backspace'&&!cell.value&&i>0) pinCells[i-1].focus(); if(ev.key==='Enter'&&i===3&&!confirmBtn.disabled) confirmBtn.click(); });
});

confirmBtn.addEventListener('click',()=>{
  const entered=getPinFromModal();
  if(entered!==state.user.pin){ pinError.textContent='Incorrect PIN'; pinError.style.display='block'; return; }
  state.user.balance=+(state.user.balance+pendingTx.amount).toFixed(2);
  state.transactions.push({...pendingTx,date:Date.now()});
  saveState(state); render(); closePinModal(); alert('Payment successful');
});
cancelBtn.addEventListener('click',()=>closePinModal());

// ===== Send Form =====
document.getElementById('sendForm').addEventListener('submit',e=>{
  e.preventDefault();
  const to=document.getElementById('recipient').value.trim();
  const acc=document.getElementById('accNumber').value.trim();
  const amount=parseFloat(document.getElementById('amount').value);
  const type=document.getElementById('type').value;
  if(!to||!acc||!amount||amount<=0){alert('Please fill valid details');return;}
  if(amount>state.user.balance){alert('Insufficient balance');return;}
  openPinModal({to:to+' • '+acc,amount:-Math.abs(amount),type});
});

// ===== Settings =====
document.getElementById('changePinBtn').addEventListener('click',()=>{
  const a=document.getElementById('newPin').value.trim();
  const b=document.getElementById('confirmPinInput').value.trim();
  if(!/^\d{4}$/.test(a)){alert('PIN must be 4 digits');return;}
  if(a!==b){alert('PINs do not match');return;}
  state.user.pin=a; saveState(state); render(); alert('PIN updated');
  document.getElementById('newPin').value=''; document.getElementById('confirmPinInput').value='';
});
document.getElementById('resetDemo').addEventListener('click',()=>{localStorage.removeItem(STORAGE_KEY);state=loadState();render();alert('Demo reset');});

// ===== Navigation =====
document.querySelectorAll('.menu button').forEach(btn=>{
  btn.addEventListener('click',()=>showView(btn.dataset.view));
});
document.getElementById('quickSend').addEventListener('click',()=>showView('send'));
document.getElementById('topUp').addEventListener('click',()=>{const amt=parseFloat(prompt('Top up amount','500'));if(amt>0){state.user.balance+=amt;state.transactions.push({to:'Top-up',amount:amt,type:'Top-up',date:Date.now()});saveState(state);render();}});

// ===== Init =====
render(); showView('dashboard');
  </script>
</body>
</html>
